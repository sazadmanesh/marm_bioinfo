---
title: "Marm_MicroEco_2025-5-20_SA"
author: "Shayda"
date: "`r Sys.Date()`"
output: html_document
---
# Setup and Datasets
```{r}
global <- config::get(config = "default")

here::i_am("Marm_Microeco_2025-5-20_SA.Rmd")
source(here::here(global$setup))
```
## Taxonomic Datasets
```{r}
dataset.main     <- read.main.microtable("tax", "main")
dataset.g1       <- read.main.microtable("tax", "group1")
dataset.g2       <- read.main.microtable("tax", "group2")
dataset.int      <- read.main.microtable("tax", "intervention")
dataset.lsk      <- read.main.microtable("tax", "ligation")
dataset.rap      <- read.main.microtable("tax", "rapid")
dataset.rap.g1   <- read.main.microtable("tax", "rapid_g1")
dataset.rap.g2   <- read.main.microtable("tax", "rapid_g2")
dataset.rap.int  <- read.main.microtable("tax", "rapid_intervention")
```
## Functional Datasets
```{r}
keg.main     <- read.func.microtable("function", "keg", "main")
keg.g1       <- read.func.microtable("function", "keg", "group1")
keg.g2       <- read.func.microtable("function", "keg", "group2")
keg.int      <- read.func.microtable("function", "keg", "intervention")
keg.lsk      <- read.func.microtable("function", "keg", "ligation")
keg.rap      <- read.func.microtable("function", "keg", "rapid")
keg.rap.g1   <- read.func.microtable("function", "keg", "rapid_g1")
keg.rap.g2   <- read.func.microtable("function", "keg", "rapid_g2")
keg.rap.int  <- read.func.microtable("function", "keg", "rapid_intervention")

fpt.main     <- read.func.microtable("function", "fpt", "main")
fpt.g1       <- read.func.microtable("function", "fpt", "group1")
fpt.g2       <- read.func.microtable("function", "fpt", "group2")
fpt.int      <- read.func.microtable("function", "fpt", "intervention")
fpt.lsk      <- read.func.microtable("function", "keg", "ligation")
fpt.rap      <- read.func.microtable("function", "keg", "rapid")
fpt.rap.g1   <- read.func.microtable("function", "keg", "rapid_g1")
fpt.rap.g2   <- read.func.microtable("function", "keg", "rapid_g2")
fpt.rap.int  <- read.func.microtable("function", "keg", "rapid_intervention")

njc.main     <- read.func.microtable("function", "njc", "main")
njc.g1       <- read.func.microtable("function", "njc", "group1")
njc.g2       <- read.func.microtable("function", "njc", "group2")
njc.int      <- read.func.microtable("function", "njc", "intervention")
njc.lsk      <- read.func.microtable("function", "keg", "ligation")
njc.rap      <- read.func.microtable("function", "keg", "rapid")
njc.rap.g1   <- read.func.microtable("function", "keg", "rapid_g1")
njc.rap.g2   <- read.func.microtable("function", "keg", "rapid_g2")
njc.rap.int  <- read.func.microtable("function", "keg", "rapid_intervention")
```
## Ordered Samples
```{r}
sample.table.order <- read.table("C:/Users/shayda/Documents/work/marm_bioinfo/microeco/datasets/dataset_main/sample_table.tsv",
                                 header = T,
                                 sep = "\t") %>%
  arrange(Study_Day, Group_Phase, Subject)

ordered.samples <- as.ordered(sample.table.order$ID)
```
# Data Visualization
## Alpha Diversity
### RAP
```{r}
alpha.rap.int <- trans_alpha$new(dataset = dataset.rap.int,
                                 group = "Group_Phase")
alpha.rap.int$cal_diff(method = "wilcox")
```
```{r}
shan.rap.intervention <- alpha.rap.int$plot_alpha(measure = "Shannon")
shan.rap.intervention
```
```{r}
ggsave("visuals/sha_wlcx_rap_int.png", shan.rap.intervention)
```
#### RAP Groups
```{r}
rap.g1.int <- clone(dataset.rap.g1)
rap.g1.int$sample_table <- dataset.rap.g1$sample_table %>%
  dplyr::filter(Group_Phase %in% c("gum", "control"))
rap.g1.int$tidy_dataset()

rap.g2.int <- clone(dataset.rap.g2)
rap.g2.int$sample_table <- dataset.rap.g2$sample_table %>%
  dplyr::filter(Group_Phase %in% c("gum", "control"))
rap.g2.int$tidy_dataset()
```
## Beta Diversity
### LSK and RAP
```{r}

```
```{r}
dataset.main$cal_betadiv()

bray.main <- trans_beta$new(
  dataset = dataset.main,
  group = "group_phase",
  measure = "bray"
)
```
```{r}
bray.main$cal_group_distance(within_group = TRUE)
bray.main$cal_group_distance_diff(method = "wilcox")
bray.main$plot_group_distance(add = "mean")
```
```{r}
bray.main$cal_ordination(method = "PCoA")
```
```{r}
bray.main.pcoa <- bray.main$plot_ordination(plot_color = "group_phase",
                                          plot_shape = "group_phase",
                                          plot_type = c("point", "ellipse"))
```
### RAP
```{r}
dataset.rap.int$cal_betadiv()

bray.rap.int <- trans_beta$new(
  dataset = dataset.rap.int,
  group = "Group_Phase",
  measure = "bray"
)
```
```{r}
bray.rap.int$cal_group_distance(within_group = TRUE)
bray.rap.int$cal_group_distance_diff(method = "wilcox")
bray.box.rap.int <- bray.rap.int$plot_group_distance(add = "mean")
bray.box.rap.int
```
```{r}
ggsave("visuals/box_bray-wlcx_rap_int.png", bray.box.rap.int)
```
```{r}
bray.rap.int$cal_ordination(method = "PCoA")
```
```{r}
bray.rap.int.pcoa <- bray.rap.int$plot_ordination(plot_color = "Group_Phase",
                                          plot_shape = "Group_Phase",
                                          plot_type = c("point", "ellipse"))
bray.rap.int.pcoa
```
```{r}
bray.rap.int.pcoa + labs(
    fill = "Intervention Diet",
    color = "Intervention Diet",
    shape = "Intervention Diet",
    title = "Principal Coordinate Analysis (PCoA) with Bray-Curtis Dissimilarity") +
  scale_fill_manual(
    values = c("control" = "#00868B", "gum" = "#EE7600"),
    labels = c("Control", "Gum")) +
  scale_color_manual(
    values = c("control" = "#00868B", "gum" = "#EE7600"),
    labels = c("Control", "Gum")) +
  scale_shape_manual(
    values = c("control" = 16, "gum" = 17),
    labels = c("Control", "Gum")) +
  theme(panel.grid = element_blank(),
        panel.background = element_blank(),
        plot.title = element_text(hjust = 0.5,
                                  size = 26),
        legend.text = element_text(size = 22),
        legend.title = element_text(size = 24),
        axis.title = element_text(size = 18),
        axis.text = element_text(size = 18))
```
```{r}
ggsave("visuals/pcoa_bray_rap_int.png", bray.rap.int.pcoa)
```
#### RAP Group 1
```{r}
rap.g1.int$cal_betadiv()

bray.rap.g1.int <- trans_beta$new(
  dataset = rap.g1.int,
  group = "Group_Phase",
  measure = "bray"
)
```
```{r}
bray.rap.g1.int$cal_group_distance(within_group = TRUE)
bray.rap.g1.int$cal_group_distance_diff(method = "wilcox")
bray.box.rap.g1.int <- bray.rap.g1.int$plot_group_distance(add = "mean")
bray.box.rap.g1.int
```
```{r}
ggsave("visuals/box_bray-wlcx_rap_g1_int.png", bray.box.rap.g1.int)
```
```{r}
bray.rap.g1.int$cal_ordination(method = "PCoA")
```
```{r}
bray.rap.g1.int.pcoa <- bray.rap.g1.int$plot_ordination(plot_color = "Group_Phase",
                                          plot_shape = "Group_Phase",
                                          plot_type = c("point", "ellipse"))
bray.rap.g1.int.pcoa
```
```{r}
bray.rap.g1.int.pcoa + labs(
    fill = "Intervention Diet",
    color = "Intervention Diet",
    shape = "Intervention Diet",
    title = "Principal Coordinate Analysis (PCoA) with Bray-Curtis Dissimilarity") +
  scale_fill_manual(
    values = c("control" = "#00868B", "gum" = "#EE7600"),
    labels = c("Control", "Gum")) +
  scale_color_manual(
    values = c("control" = "#00868B", "gum" = "#EE7600"),
    labels = c("Control", "Gum")) +
  scale_shape_manual(
    values = c("control" = 16, "gum" = 17),
    labels = c("Control", "Gum")) +
  theme(panel.grid = element_blank(),
        panel.background = element_blank(),
        plot.title = element_text(hjust = 0.5,
                                  size = 26),
        legend.text = element_text(size = 22),
        legend.title = element_text(size = 24),
        axis.title = element_text(size = 18),
        axis.text = element_text(size = 18))
```
# Abundance
## Taxonomic
```{r}
phy.abund.rap <- trans_abund$new(dataset = dataset.rap,
                             taxrank = "Phylum")
cla.abund.rap <- trans_abund$new(dataset = dataset.rap,
                             taxrank = "Class")
ord.abund.rap <- trans_abund$new(dataset = dataset.rap,
                             taxrank = "Order")
fam.abund.rap <- trans_abund$new(dataset = dataset.rap,
                             taxrank = "Family")
gen.abund.rap <- trans_abund$new(dataset = dataset.rap,
                             taxrank = "Genus")
spe.abund.rap <- trans_abund$new(dataset = dataset.rap,
                             taxrank = "Species")
```
```{r}
phy.abund.rap$plot_bar(bar_full = F, use_alluvium = T, clustering = F, xtext_keep = F, 
                        color_values = paletteer::paletteer_d("pals::tol"), 
                        facet = c("Group"),
                        order_x = c(ordered.samples))
```
```{r}
cla.abund.rap$plot_bar(bar_full = F, use_alluvium = T, clustering = F, xtext_keep = F, 
                        color_values = paletteer::paletteer_d("pals::tol"), 
                        facet = c("Group"),
                        order_x = c(ordered.samples))
```
```{r}
ord.abund.rap$plot_bar(bar_full = F, use_alluvium = T, clustering = F, xtext_keep = F, 
                        color_values = paletteer::paletteer_d("pals::tol"), 
                        facet = c("Group"),
                        order_x = c(ordered.samples))
```
```{r}
fam.abund.rap$plot_bar(bar_full = F, use_alluvium = T, clustering = F, xtext_keep = F, 
                        color_values = paletteer::paletteer_d("pals::tol"), 
                        facet = c("Group"),
                        order_x = c(ordered.samples))
```
```{r}
gen.abund.rap$plot_bar(bar_full = F, use_alluvium = T, clustering = F, xtext_keep = F, 
                        color_values = paletteer::paletteer_d("pals::tol"), 
                        facet = c("Group"),
                        order_x = c(ordered.samples))
```
### Diff
```{r}
wlcx.rap.int <- trans_diff$new(
  dataset = dataset.rap.int,
  method = "wilcox",
  group = "Group_Phase",
  alpha = 0.05,
  filter_thres = 0.001)
wlcx.rap.int$res_diff %<>% subset(Significance %in% c("*","**","***"))
wlcx.rap.intervention <- wlcx.rap.int$plot_diff_abund(
                                              use_number = 1:16,
                                              add_sig = TRUE,
                                              group_order = c("control", "gum"))
wlcx.rap.intervention
```

```{r}
rap.g1.int <- clone(dataset.rap.g1)
rap.g1.int$sample_table <- dataset.rap.g1$sample_table %>%
  dplyr::filter(Group_Phase %in% c("gum", "control"))
rap.g1.int$tidy_dataset()

rap.g2.int <- clone(dataset.rap.g2)
rap.g2.int$sample_table <- dataset.rap.g2$sample_table %>%
  dplyr::filter(Group_Phase %in% c("gum", "control"))
rap.g2.int$tidy_dataset()
```
```{r}
wlcx.rap.g1 <- trans_diff$new(
  dataset = rap.g1.int,
  method = "wilcox",
  group = "Group_Phase",
  alpha = 0.05,
  filter_thres = 0.001)
wlcx.rap.g1$res_diff %<>% subset(Significance %in% c("*","**","***"))
wlcx.rap.group1 <- wlcx.rap.g1$plot_diff_abund(
                                              use_number = 1:16,
                                              add_sig = TRUE)
wlcx.rap.group1
```
```{r}
wlcx.rap.g2 <- trans_diff$new(
  dataset = rap.g2.int,
  method = "wilcox",
  group = "Group_Phase",
  alpha = 0.05,
  filter_thres = 0.001)
wlcx.rap.g2$res_diff %<>% subset(Significance %in% c("*","**","***"))
wlcx.rap.group2 <- wlcx.rap.g2$plot_diff_abund(
                                              use_number = 1:16,
                                              add_sig = TRUE)
wlcx.rap.group2
```
```{r}
rap.lfs.gp <- trans_diff$new(
  dataset = dataset.rap,
  method = "lefse",
  group = "Group_Phase",
  alpha = 0.05,
  filter_thres = 0.001)

rap.lfs.gp$plot_diff_abund()
```
## Functional
### KEGG
```{r}
keg.1.rap <- trans_abund$new(dataset = keg.rap,
                            taxrank = "Level.1")
keg.1.rap$plot_bar(bar_full = F, use_alluvium = T, clustering = F, xtext_keep = F, 
                        color_values = paletteer::paletteer_d("pals::tol"), 
                        facet = c("Group"),
                        order_x = c(ordered.samples))
```
```{r}
keg.2.rap <- trans_abund$new(dataset = keg.rap,
                            taxrank = "Level.2")
keg.2.rap$plot_bar(bar_full = F, use_alluvium = T, clustering = F, xtext_keep = F, 
                        color_values = paletteer::paletteer_d("pals::tol"), 
                        facet = c("Group"),
                        order_x = c(ordered.samples))
```
```{r}
keg.3.rap <- trans_abund$new(dataset = keg.rap,
                            taxrank = "Level.3")
keg.3.rap$plot_bar(bar_full = F, use_alluvium = T, clustering = F, xtext_keep = F, 
                        color_values = paletteer::paletteer_d("pals::tol"), 
                        facet = c("Group"),
                        order_x = c(ordered.samples))
```
```{r}
wlcx.keg.rap.int <- trans_diff$new(
  dataset = keg.rap.int,
  method = "wilcox",
  group = "Group_Phase",
  alpha = 0.05,
  filter_thres = 0.001)
wlcx.keg.rap.int$res_diff %<>% subset(Significance %in% c("*","**","***"))
wlcx.keg.rap.intervention <- wlcx.keg.rap.int$plot_diff_abund(
                                              use_number = 1:16,
                                              add_sig = TRUE)
```
### FAPROTAX
```{r}
fpt.func.rap <- trans_abund$new(dataset = fpt.rap,
                            taxrank = "Function")
fpt.func.rap$plot_bar(bar_full = F, use_alluvium = T, clustering = F, xtext_keep = F, 
                        color_values = paletteer::paletteer_d("pals::tol"), 
                        facet = c("Group"),
                        order_x = c(ordered.samples))
```
```{r}
wlcx.fpt.rap.int <- trans_diff$new(
  dataset = fpt.data.rap.int,
  method = "wilcox",
  group = "Group_Phase",
  alpha = 0.05,
  filter_thres = 0.001)
wlcx.fpt.rap.int$res_diff %<>% subset(Significance %in% c("*","**","***"))
wlcx.fpt.rap.intervention <- wlcx.fpt.rap.int$plot_diff_abund(
                                              use_number = 1:16,
                                              add_sig = TRUE)
```
### NJC19
```{r}
njc.func.rap <- trans_abund$new(dataset = njc.rap,
                            taxrank = "Function")
njc.func.rap$plot_bar(bar_full = F, use_alluvium = T, clustering = F, xtext_keep = F, 
                        color_values = paletteer::paletteer_d("pals::tol"), 
                        facet = c("Group"),
                        order_x = c(ordered.samples))
```
```{r}
wlcx.njc.rap.int <- trans_diff$new(
  dataset = njc.data.rap.int,
  method = "wilcox",
  group = "Group_Phase",
  alpha = 0.05,
  filter_thres = 0.001)
wlcx.njc.rap.int$res_diff %<>% subset(Significance %in% c("*","**","***"))
wlcx.njc.rap.intervention <- wlcx.njc.rap.int$plot_diff_abund(
                                              use_number = 1:16,
                                              add_sig = TRUE)
```


```{r}
gen.phy.rap.g1 <- trans_abund$new(
  dataset = dataset.rap.g1,
  ntaxa = 30,
  taxrank = "Genus",
  high_level = "Phylum",
  groupmean = "Group_Phase",
  group_morestats = T)
gen.phy.rap.g1$plot_bar(ggnested = T,
                     order_x = c("run-in",
                                 "gum",
                                 "gum-washout",
                                 "control",
                                 "control-washout"))
```
```{r}
gen.phy.rap.g2 <- trans_abund$new(
  dataset = dataset.rap.g2,
  ntaxa = 30,
  taxrank = "Genus",
  high_level = "Phylum",
  groupmean = "Group_Phase",
  group_morestats = T)
gen.phy.rap.g2$plot_bar(ggnested = T,
                     order_x = c("run-in",
                                 "control",
                                 "control-washout",
                                 "gum",
                                 "gum-washout"))
```
```{r}
gen.phy.rap.int <- trans_abund$new(
  dataset = dataset.rap.int,
  ntaxa = 30,
  taxrank = "Genus",
  high_level = "Phylum",
  groupmean = "Group_Phase",
  group_morestats = T)
gen.phy.rap.int$plot_bar(ggnested = T,
                     order_x = c("control", "gum"))
```
```{r}
gen.int <- trans_abund$new(dataset = dataset.int,
                             taxrank = "Genus",
                             ntaxa = 40)
gen.hm.int <- gen.int$plot_heatmap(facet = c("group", "group_phase"),
                                 xtext_keep = FALSE,
                                 withmargin = FALSE,
                                 plot_breaks = c(0.01, 0.1, 1, 10),
                                 order_x = c(ordered.samples))
gen.hm.int
```
```{r}
spe.fam.int <- trans_abund$new(
  dataset = dataset.int,
  ntaxa = 25,
  taxrank = "Species",
  high_level = "Family",
  groupmean = "group_phase",
  group_morestats = T)
spe.fam.int$plot_bar(ggnested = T,
                     order_x = c("control", "gum"))
  

```